<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Orpheus by Radagaisus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Orpheus</h1>
      <h2 class="project-tagline">A Small CoffeeScript Object Model for Redis</h2>
      <a href="https://github.com/Radagaisus/Orpheus" class="btn">View on GitHub</a>
      <a href="https://github.com/Radagaisus/Orpheus/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/Radagaisus/Orpheus/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="orpheus---redis-little-helper" class="anchor" href="#orpheus---redis-little-helper" aria-hidden="true"><span class="octicon octicon-link"></span></a>Orpheus - Redis Little Helper</h1>

<p>Orpheus is a Redis Object Model for CoffeeScript.</p>

<p><code>npm install orpheus</code></p>

<ul>
<li>Rails like models</li>
<li>Sexy DSL</li>
<li>simple relations</li>
<li>transactional spirit, with multi</li>
<li>Dynamic keys</li>
<li>Maps between strings and ids</li>
<li>Validations</li>
</ul>

<p>If you are using Orpheus please ping me on <a href="http://twitter.com/#!/radagaisus">Twitter</a> or <a href="http://enginezombie.com/">EngineZombie</a>. It will make me happy.</p>

<h2>
<a id="a-small-taste" class="anchor" href="#a-small-taste" aria-hidden="true"><span class="octicon octicon-link"></span></a>A Small Taste</h2>

<div class="highlight highlight-coffee"><pre>  <span class="pl-k">class</span> <span class="pl-en">User</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
    <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
      <span class="pl-smi">@has</span> <span class="pl-s"><span class="pl-pds">'</span>book<span class="pl-pds">'</span></span>

      <span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>about_me<span class="pl-pds">'</span></span>
      <span class="pl-smi">@num</span> <span class="pl-s"><span class="pl-pds">'</span>points<span class="pl-pds">'</span></span>
      <span class="pl-smi">@set</span> <span class="pl-s"><span class="pl-pds">'</span>likes<span class="pl-pds">'</span></span>
      <span class="pl-smi">@zset</span> <span class="pl-s"><span class="pl-pds">'</span>ranking<span class="pl-pds">'</span></span>

      <span class="pl-smi">@map</span> <span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>fb_id<span class="pl-pds">'</span></span>
      <span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>fb_secret<span class="pl-pds">'</span></span>

  <span class="pl-v"><span class="pl-v">user <span class="pl-k">=</span></span></span> Player.create()

  user(<span class="pl-s"><span class="pl-pds">'</span>modest<span class="pl-pds">'</span></span>)
    .add
      <span class="pl-v"><span class="pl-v">about_me:</span></span> <span class="pl-s"><span class="pl-pds">'</span>I like douchebags and watermelon<span class="pl-pds">'</span></span>
      <span class="pl-v"><span class="pl-v">points:</span></span> <span class="pl-c1">5</span>
    .books.add(<span class="pl-s"><span class="pl-pds">'</span>dune<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>maybe some proust<span class="pl-pds">'</span></span>)
    .err <span class="pl-smi">(err)</span> <span class="pl-k">-&gt;</span>
      res.json err.toResponse()
    .exec <span class="pl-k">-&gt;</span>
      <span class="pl-c"># woho!</span></pre></div>

<h2>
<a id="types" class="anchor" href="#types" aria-hidden="true"><span class="octicon octicon-link"></span></a>Types</h2>

<p>Orpheus supports all the basic types of Redis: <code>@num</code>, <code>@str</code>, <code>@list</code>, <code>@set</code>, <code>@zset</code> and <code>@hash</code>. Note that strings and numbers are stored inside the model hash. See the wiki for <a href="https://github.com/Radagaisus/Orpheus/wiki">supported commands and key names for each type</a>.</p>

<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration</h2>

<div class="highlight highlight-coffee"><pre>Orpheus.configure
   <span class="pl-v"><span class="pl-v">client:</span></span> redis.createClient()
   <span class="pl-v"><span class="pl-v">prefix:</span></span> <span class="pl-s"><span class="pl-pds">'</span>bookapp<span class="pl-pds">'</span></span></pre></div>

<p>Options:</p>

<ul>
<li>
<strong>client</strong>: the Redis client.</li>
<li>
<strong>prefix</strong>: optional prefix for keys. defaults to <code>orpheus</code>.</li>
</ul>

<h2>
<a id="issuing-commands-with-orpheus" class="anchor" href="#issuing-commands-with-orpheus" aria-hidden="true"><span class="octicon octicon-link"></span></a>Issuing Commands with Orpheus</h2>

<h3>
<a id="the-straightforward-way" class="anchor" href="#the-straightforward-way" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Straightforward Way</h3>

<div class="highlight highlight-coffee"><pre>  user(<span class="pl-s"><span class="pl-pds">'</span>rada<span class="pl-pds">'</span></span>)
    .name.hset(<span class="pl-s"><span class="pl-pds">'</span>radagaisus<span class="pl-pds">'</span></span>)
    .points.hincrby(<span class="pl-c1">5</span>)
    .points_by_time.zincrby(<span class="pl-c1">5</span>, <span class="pl-k">new</span> <span class="pl-en">Date</span>().getTime())
    .books.sadd(<span class="pl-s"><span class="pl-pds">'</span>dune<span class="pl-pds">'</span></span>)</pre></div>

<p>Note you don't need to add the command prefix in this cases:</p>

<div class="highlight highlight-coffee"><pre><span class="pl-v"><span class="pl-v">shorthands:</span></span>
  <span class="pl-v"><span class="pl-v">str:</span></span> <span class="pl-s"><span class="pl-pds">'</span>h<span class="pl-pds">'</span></span>
  <span class="pl-v"><span class="pl-v">num:</span></span> <span class="pl-s"><span class="pl-pds">'</span>h<span class="pl-pds">'</span></span>
  <span class="pl-v"><span class="pl-v">list:</span></span> <span class="pl-s"><span class="pl-pds">'</span>l<span class="pl-pds">'</span></span>
  <span class="pl-v"><span class="pl-v">set:</span></span> <span class="pl-s"><span class="pl-pds">'</span>s<span class="pl-pds">'</span></span>
  <span class="pl-v"><span class="pl-v">zset:</span></span> <span class="pl-s"><span class="pl-pds">'</span>z<span class="pl-pds">'</span></span>
  <span class="pl-v"><span class="pl-v">hash:</span></span> <span class="pl-s"><span class="pl-pds">'</span>h<span class="pl-pds">'</span></span></pre></div>

<p>So the commands above could have been just <code>set</code>, <code>incrby</code> and <code>add</code>.</p>

<h3>
<a id="adding-setting-deleting" class="anchor" href="#adding-setting-deleting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding, Setting, Deleting</h3>

<div class="highlight highlight-coffee"><pre>user(<span class="pl-s"><span class="pl-pds">'</span>dune<span class="pl-pds">'</span></span>)
  .add
    <span class="pl-v"><span class="pl-v">points:</span></span> <span class="pl-c1">20</span>
    <span class="pl-v"><span class="pl-v">ranking:</span></span> [<span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>best book ever!<span class="pl-pds">'</span></span>]
  .set
    <span class="pl-v"><span class="pl-v">name:</span></span> <span class="pl-s"><span class="pl-pds">'</span>sequel<span class="pl-pds">'</span></span>
  .exec()</pre></div>

<pre><code>add:
    num:  'hincrby'
    str:  'hset'
    set:  'sadd'
    zset: 'zincrby'
    list: 'lpush'

set:
    num:  'hset'
    str:  'hset'
    set:  'sadd'
    zset: 'zadd'
    list: 'lpush'
</code></pre>

<h3>
<a id="getting-stuff" class="anchor" href="#getting-stuff" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Stuff</h3>

<p>Getting the entire model in Orpheus is pretty easy:</p>

<div class="highlight highlight-coffee"><pre>user.get <span class="pl-smi">(err, user)</span> <span class="pl-k">-&gt;</span>
  res.json user</pre></div>

<p>Here's how get asks for different types:</p>

<div class="highlight highlight-coffee"><pre><span class="pl-k">switch</span> type
  <span class="pl-k">when</span> <span class="pl-s"><span class="pl-pds">'</span>str<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>num<span class="pl-pds">'</span></span>
    <span class="pl-smi">@</span>[key].get()
  <span class="pl-k">when</span> <span class="pl-s"><span class="pl-pds">'</span>list<span class="pl-pds">'</span></span>
    <span class="pl-smi">@</span>[key].range <span class="pl-c1">0</span>, <span class="pl-k">-</span><span class="pl-c1">1</span>
  <span class="pl-k">when</span> <span class="pl-s"><span class="pl-pds">'</span>set<span class="pl-pds">'</span></span>
    <span class="pl-smi">@</span>[key].members()
  <span class="pl-k">when</span> <span class="pl-s"><span class="pl-pds">'</span>zset<span class="pl-pds">'</span></span>
    <span class="pl-smi">@</span>[key].range <span class="pl-c1">0</span>, <span class="pl-k">-</span><span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>withscores<span class="pl-pds">'</span></span>
  <span class="pl-k">when</span> <span class="pl-s"><span class="pl-pds">'</span>hash<span class="pl-pds">'</span></span>
    <span class="pl-smi">@</span>[key].hgetall()</pre></div>

<p>Specific queries for getting stuff will also convert the response to an object, provided all the commands issued are for getting stuff (no incrby or lpush somewhere in the query).</p>

<div class="highlight highlight-coffee"><pre><span class="pl-en">get_user</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">(fn)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
      <span class="pl-smi">@name</span>.get()
      <span class="pl-smi">@fb_id</span>.get()
      <span class="pl-smi">@fb_friends</span>.get()
      <span class="pl-smi">@member_since</span>.get()
      <span class="pl-smi">@exec</span> fn</pre></div>

<p>Converting to object supports this commands:</p>

<div class="highlight highlight-coffee"><pre><span class="pl-v"><span class="pl-v">getters:</span></span> [
  <span class="pl-c"># String, Number</span>
  <span class="pl-s"><span class="pl-pds">'</span>hget<span class="pl-pds">'</span></span>,

  <span class="pl-c"># List</span>
  <span class="pl-s"><span class="pl-pds">'</span>lrange<span class="pl-pds">'</span></span>,

  <span class="pl-c"># Set</span>
  <span class="pl-s"><span class="pl-pds">'</span>smembers<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>scard<span class="pl-pds">'</span></span>,

  <span class="pl-c"># Zset</span>
  <span class="pl-s"><span class="pl-pds">'</span>zrange<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>zrangebyscore<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>zrevrange<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>zrevrangebyscore<span class="pl-pds">'</span></span>

  <span class="pl-c"># Hash</span>
  <span class="pl-s"><span class="pl-pds">'</span>hget<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>hgetall<span class="pl-pds">'</span></span>,
  <span class="pl-s"><span class="pl-pds">'</span>hmget<span class="pl-pds">'</span></span>
]</pre></div>

<p>Getting stuff while updating stuff in the same query will return the results in an array, the same way a Redis multi() command will return the results.</p>

<h3>
<a id="err-and-exec" class="anchor" href="#err-and-exec" aria-hidden="true"><span class="octicon octicon-link"></span></a>Err and Exec</h3>

<p>Orpheus uses the <code>.err()</code> function for handling validation and unexpected errors. If <code>.err()</code> is not set the <code>.exec()</code> command receives errors as the first parameter.</p>

<div class="highlight highlight-coffee"><pre>user(<span class="pl-s"><span class="pl-pds">'</span>sonic youth<span class="pl-pds">'</span></span>)
  .add
    <span class="pl-v"><span class="pl-v">name:</span></span> <span class="pl-s"><span class="pl-pds">'</span>modest mouse<span class="pl-pds">'</span></span>
    <span class="pl-v"><span class="pl-v">points:</span></span> <span class="pl-c1">50</span>
  .err <span class="pl-smi">(err)</span> <span class="pl-k">-&gt;</span>
    <span class="pl-k">if</span> err.type <span class="pl-k">is</span> <span class="pl-s"><span class="pl-pds">'</span>validation<span class="pl-pds">'</span></span>
      <span class="pl-c"># phew, it's just a validation error</span>
      res.json err.toResponse()
    <span class="pl-k">else</span>
      <span class="pl-c"># Redis Error, or a horrendous</span>
      <span class="pl-c"># bug in Orpheus</span>
      log <span class="pl-s"><span class="pl-pds">"</span>Wake the sysadmins! <span class="pl-s1"><span class="pl-pse">#{</span>err<span class="pl-pse">}</span></span><span class="pl-pds">"</span></span>
      res.json <span class="pl-v"><span class="pl-v">status:</span></span> <span class="pl-c1">500</span>
  .exec <span class="pl-smi">(res, id)</span> <span class="pl-k">-&gt;</span>
    <span class="pl-c"># fun!</span></pre></div>

<p><strong>Without Err</strong>:</p>

<div class="highlight highlight-coffee"><pre>user(<span class="pl-s"><span class="pl-pds">'</span>putin<span class="pl-pds">'</span></span>)
  .add
    <span class="pl-v"><span class="pl-v">name:</span></span> <span class="pl-s"><span class="pl-pds">'</span>putout<span class="pl-pds">'</span></span>
  .exec <span class="pl-smi">(err, res, id)</span> <span class="pl-k">-&gt;</span>
    <span class="pl-c"># err is the first parameter</span>
    <span class="pl-c"># everything else as usual</span></pre></div>

<h3>
<a id="separate-callbacks" class="anchor" href="#separate-callbacks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Separate Callbacks</h3>

<p>Just like with the <code>multi</code> command you can supply a separate callback for specific commands.</p>

<div class="highlight highlight-coffee"><pre>user(<span class="pl-s"><span class="pl-pds">'</span>mgmt<span class="pl-pds">'</span></span>)
  .pokemons.<span class="pl-c1">push</span>(<span class="pl-s"><span class="pl-pds">'</span>pikachu<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>charizard<span class="pl-pds">'</span></span>, redis.print)
  .err
    <span class="pl-k">-&gt;</span> <span class="pl-c"># ...</span>
  .exec <span class="pl-k">-&gt;</span>
    <span class="pl-c"># ...</span></pre></div>

<h3>
<a id="conditional-commands" class="anchor" href="#conditional-commands" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conditional Commands</h3>

<p>Sometimes you'll want to only issue specific commands based on a condition. If you don't want to break the chaining and clutter the code, use <code>.when(fn)</code>. <code>When</code> executes <code>fn</code> immediately, with the context set to the model context. <code>only</code> is an alias for <code>when</code>.</p>

<div class="highlight highlight-coffee"><pre><span class="pl-v"><span class="pl-v">info <span class="pl-k">=</span></span></span> get_mission_critical_information()
player(<span class="pl-s"><span class="pl-pds">'</span>danny<span class="pl-pds">'</span></span>).when( <span class="pl-k">-&gt;</span>
    <span class="pl-k">if</span> info <span class="pl-k">is</span> <span class="pl-s"><span class="pl-pds">'</span>nah, never mind<span class="pl-pds">'</span></span> <span class="pl-k">then</span> <span class="pl-smi">@name</span>.set(<span class="pl-s"><span class="pl-pds">'</span>oh YEAHH<span class="pl-pds">'</span></span>)
).points.incrby(<span class="pl-c1">5</span>) <span class="pl-c"># Business as usual</span>
.exec()</pre></div>

<h3>
<a id="relations" class="anchor" href="#relations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Relations</h3>

<div class="highlight highlight-coffee"><pre><span class="pl-k">class</span> <span class="pl-en">User</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
  <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
    <span class="pl-smi">@has</span> <span class="pl-s"><span class="pl-pds">'</span>book<span class="pl-pds">'</span></span>

<span class="pl-k">class</span> <span class="pl-en">Book</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
  <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
    <span class="pl-smi">@has</span> <span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>

<span class="pl-v"><span class="pl-v">user <span class="pl-k">=</span></span></span> User.create()
<span class="pl-v"><span class="pl-v">book <span class="pl-k">=</span></span></span> Book.create()

<span class="pl-c"># Every relation means a set for that relation</span>
user(<span class="pl-s"><span class="pl-pds">'</span>chaplin<span class="pl-pds">'</span></span>).books.smembers <span class="pl-smi">(err, book_ids)</span> <span class="pl-k">-&gt;</span>

  <span class="pl-c"># With async functions for fun and profit</span>
  user(<span class="pl-s"><span class="pl-pds">'</span>chaplin<span class="pl-pds">'</span></span>).books.<span class="pl-c1">map</span> book_ids, <span class="pl-smi">(id, cb, i)</span> <span class="pl-k">-&gt;</span>
      book(id).get cb
    <span class="pl-smi">(err, books)</span> <span class="pl-k">-&gt;</span>
      <span class="pl-c"># What? Did we just retrieved all the books from Redis?</span></pre></div>

<h2>
<a id="dynamic-keys" class="anchor" href="#dynamic-keys" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dynamic Keys</h2>

<div class="highlight highlight-coffee"><pre><span class="pl-k">class</span> <span class="pl-en">User</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
  <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
    <span class="pl-smi">@zset</span> <span class="pl-s"><span class="pl-pds">'</span>monthly_ranking<span class="pl-pds">'</span></span>
      <span class="pl-en">key</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
        <span class="pl-v"><span class="pl-v">d <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">Date</span>()
        <span class="pl-c"># prefix:user:id:ranking:2012:5</span>
        <span class="pl-s"><span class="pl-pds">"</span>ranking:<span class="pl-s1"><span class="pl-pse">#{</span>d.getFullYear()<span class="pl-pse">}</span></span>:<span class="pl-s1"><span class="pl-pse">#{</span>d.getMonth()<span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-pse">}</span></span><span class="pl-pds">"</span></span>

<span class="pl-v"><span class="pl-v">user <span class="pl-k">=</span></span></span> User.create()
user(<span class="pl-s"><span class="pl-pds">'</span>jackson<span class="pl-pds">'</span></span>)
  .monthly_ranking.incrby(<span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>Midnight Oil - The Dead Heart<span class="pl-pds">'</span></span>)
  .exec <span class="pl-k">-&gt;</span>
    res.json <span class="pl-v"><span class="pl-v">status:</span></span> <span class="pl-c1">200</span></pre></div>

<p>Using arguments in dyanmic keys is easy:</p>

<div class="highlight highlight-coffee"><pre><span class="pl-smi">@zset</span> <span class="pl-s"><span class="pl-pds">'</span>monthly_ranking<span class="pl-pds">'</span></span>
  <span class="pl-en">key</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">(year, month)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
    <span class="pl-s"><span class="pl-pds">"</span>ranking:<span class="pl-s1"><span class="pl-pse">#{</span>year <span class="pl-k">||</span> d.getFullYear()<span class="pl-pse">}</span></span>:<span class="pl-s1"><span class="pl-pse">#{</span>month <span class="pl-k">||</span> d.getMonth()<span class="pl-k">+</span><span class="pl-c1">1</span><span class="pl-pse">}</span></span><span class="pl-pds">"</span></span>

<span class="pl-c"># later on, in a far away place...</span>
user(<span class="pl-s"><span class="pl-pds">'</span>bean<span class="pl-pds">'</span></span>)
  .monthly_ranking.incrby(<span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>Stoned Jesus - I<span class="pl-pds">'</span></span>m The Mountain<span class="pl-s"><span class="pl-pds">'</span>, key: [2012, 12])</span></pre></div>

<p>Everything inside <code>key</code> will be passed to the dynamic key function.</p>

<h2>
<a id="one-to-one-maps" class="anchor" href="#one-to-one-maps" aria-hidden="true"><span class="octicon octicon-link"></span></a>One to One Maps</h2>

<p>Maps are used to map between a unique attribute of the model and the model ID.</p>

<p>Internally maps use a hash <code>prefix:users:map:fb_ids</code>.</p>

<p>This example uses the excellent <a href="passportjs.org">PassportJS</a>.</p>

<div class="highlight highlight-coffee"><pre><span class="pl-en">fb_connect </span><span class="pl-k">=</span><span class="pl-smi"> <span class="pl-smi">(req, res, next)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
  <span class="pl-v"><span class="pl-v">fb <span class="pl-k">=</span></span></span> req.account
  <span class="pl-v"><span class="pl-v">fb_details <span class="pl-k">=</span></span></span>
    <span class="pl-v"><span class="pl-v">fb_id:</span></span>    fb.id
    <span class="pl-v"><span class="pl-v">fb_name:</span></span>  fb.displayName
    <span class="pl-v"><span class="pl-v">fb_token:</span></span> fb.token
    <span class="pl-v"><span class="pl-v">fb_gener:</span></span> fb.gender
    <span class="pl-v"><span class="pl-v">fb_url:</span></span>   fb.profileUrl

  <span class="pl-v"><span class="pl-v">id <span class="pl-k">=</span></span></span> <span class="pl-k">if</span> req.user <span class="pl-k">then</span> req.user.id <span class="pl-k">else</span> <span class="pl-v"><span class="pl-v">fb_id:</span></span> fb.id
  player id, <span class="pl-smi">(err, player, is_new)</span> <span class="pl-k">-&gt;</span>
    next err <span class="pl-k">if</span> err
    <span class="pl-c"># That's it, we just handled autorization,</span>
    <span class="pl-c"># new users and authentication in one go</span>
    player
      .set(fb_details)
      .exec <span class="pl-smi">(err, res, user_id)</span> <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">req.session.passport.user <span class="pl-k">=</span></span></span> user_id <span class="pl-k">if</span> user_id
        next err</pre></div>

<h4>
<a id="what-just-happened" class="anchor" href="#what-just-happened" aria-hidden="true"><span class="octicon octicon-link"></span></a>What Just Happened?</h4>

<p>There are two scenarios:</p>

<ol>
<li><p><strong>Authentication</strong>: <code>req.user</code> is undefined, so the user is not logged in. We create an object <code>{fb_id: fb.id}</code> to use in the map. Orpheus requests <code>hget prefix:users:map:fb_ids fb_id</code>. If a match is found we continue as usual. Otherwise a new user is created. In both cases, the user's Facebook information is updated.</p></li>
<li><p><strong>Authorization</strong>: <code>req.user</code> is defined. The anonymous function is called right away and the user's Facebook information is updated.</p></li>
</ol>

<h2>
<a id="validations" class="anchor" href="#validations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Validations</h2>

<p>Validations are based on the input, not on the object itself. For example, <code>hincrby 5</code> will validate the number 5 itself, not the accumulated value in the object.</p>

<p>Validations run synchronously.</p>

<div class="highlight highlight-coffee"><pre><span class="pl-k">class</span> <span class="pl-en">User</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
  <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
    <span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>
    <span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-smi">(s)</span> <span class="pl-k">-&gt;</span> <span class="pl-k">if</span> s <span class="pl-k">is</span> <span class="pl-s"><span class="pl-pds">'</span>something<span class="pl-pds">'</span></span> <span class="pl-k">then</span> <span class="pl-c1">true</span> <span class="pl-k">else</span> <span class="pl-s"><span class="pl-pds">'</span>name should be "something".<span class="pl-pds">'</span></span>

<span class="pl-v"><span class="pl-v">player <span class="pl-k">=</span></span></span> Player.create()
player(<span class="pl-s"><span class="pl-pds">'</span>james<span class="pl-pds">'</span></span>).set
  <span class="pl-v"><span class="pl-v">name:</span></span> <span class="pl-s"><span class="pl-pds">'</span>james!!!<span class="pl-pds">'</span></span>
.err <span class="pl-smi">(err)</span> <span class="pl-k">-&gt;</span>
  <span class="pl-k">if</span> err.type <span class="pl-k">is</span> <span class="pl-s"><span class="pl-pds">'</span>validation<span class="pl-pds">'</span></span>
    log err <span class="pl-c"># &lt;OrpheusValidationErrors&gt;</span>
  <span class="pl-k">else</span>
    <span class="pl-c"># something is wrong with redis</span>
.exec <span class="pl-smi">(res)</span> <span class="pl-k">-&gt;</span>
  <span class="pl-c"># Never ever land</span></pre></div>

<p><strong>OrpheusValidationErrors</strong> has a few convenience functions:</p>

<ul>
<li>
<strong>add</strong>: adds an error</li>
<li>
<strong>empty</strong>: clears the errors</li>
<li>
<strong>toResponse</strong>: returns a JSON:</li>
</ul>

<div class="highlight highlight-coffee"><pre>{
  <span class="pl-v"><span class="pl-v">status:</span></span> <span class="pl-c1">400</span>, <span class="pl-c"># Bad Request</span>
  <span class="pl-v"><span class="pl-v">errors:</span></span>
    <span class="pl-v"><span class="pl-v">name:</span></span> [<span class="pl-s"><span class="pl-pds">'</span>name should be "something".<span class="pl-pds">'</span></span>]
}</pre></div>

<p><code>errors</code> contains the actual error objects:</p>

<div class="highlight highlight-coffee"><pre>{
  <span class="pl-v"><span class="pl-v">name:</span></span> [
    <span class="pl-v"><span class="pl-v">msg:</span></span> <span class="pl-s"><span class="pl-pds">'</span>name should be "something".<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">command:</span></span> <span class="pl-s"><span class="pl-pds">'</span>hset<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">args:</span></span> [<span class="pl-s"><span class="pl-pds">'</span>james!!!<span class="pl-pds">'</span></span>],
    <span class="pl-v"><span class="pl-v">value:</span></span> <span class="pl-s"><span class="pl-pds">'</span>james!!!<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">date:</span></span> <span class="pl-c1">1338936463054</span> <span class="pl-c"># new Date().getTime()</span>
  ],
  <span class="pl-c"># ...</span>
}</pre></div>

<h3>
<a id="customizing-message" class="anchor" href="#customizing-message" aria-hidden="true"><span class="octicon octicon-link"></span></a>Customizing Message</h3>

<div class="highlight highlight-coffee"><pre><span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>legacy_code<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">format:</span></span> <span class="pl-sr"><span class="pl-pds">/</span><span class="pl-k">^</span><span class="pl-c1">[<span class="pl-c1">a-zA-Z</span>]</span><span class="pl-k">+</span><span class="pl-k">$</span><span class="pl-pds">/</span></span>
    <span class="pl-en">message</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">(val)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-pse">#{</span>val<span class="pl-pse">}</span></span> must be only A-Za-z<span class="pl-pds">"</span></span></pre></div>

<p>Will do the trick. Number validations do not support customized messages yet.</p>

<h3>
<a id="custom-validations" class="anchor" href="#custom-validations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Validations</h3>

<div class="highlight highlight-coffee"><pre><span class="pl-k">class</span> <span class="pl-en">Player</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
    <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
        <span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>
        <span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-smi">(s)</span> <span class="pl-k">-&gt;</span> <span class="pl-k">if</span> s <span class="pl-k">is</span> <span class="pl-s"><span class="pl-pds">'</span>babomb<span class="pl-pds">'</span></span> <span class="pl-k">then</span> <span class="pl-c1">true</span> <span class="pl-k">else</span> <span class="pl-s"><span class="pl-pds">'</span>String should be babomb.<span class="pl-pds">'</span></span></pre></div>

<h3>
<a id="number-validations" class="anchor" href="#number-validations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Number Validations</h3>

<div class="highlight highlight-coffee"><pre><span class="pl-smi">@num</span> <span class="pl-s"><span class="pl-pds">'</span>points<span class="pl-pds">'</span></span>

<span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>points<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">numericality:</span></span>
        <span class="pl-v"><span class="pl-v">only_integer:</span></span> <span class="pl-c1">true</span>
        <span class="pl-v"><span class="pl-v">greater_than:</span></span> <span class="pl-c1">3</span>
        <span class="pl-v"><span class="pl-v">greater_than_or_equal_to:</span></span> <span class="pl-c1">3</span>
        <span class="pl-v"><span class="pl-v">equal_to:</span></span> <span class="pl-c1">3</span>
        <span class="pl-v"><span class="pl-v">less_than_or_equal_to:</span></span> <span class="pl-c1">3</span>
        <span class="pl-v"><span class="pl-v">odd:</span></span> <span class="pl-c1">true</span></pre></div>

<p>Options:</p>

<ul>
<li>
<strong>only_integer</strong>: <code>"#{n} must be an integer."</code>
</li>
<li>
<strong>greater_than</strong>: <code>"#{a} must be greater than #{b}."</code>
</li>
<li>
<strong>greater_than_or_equal_to</strong>: <code>"#{a} must be greater than or equal to #{b}."</code>
</li>
<li>
<strong>equal_to</strong>: <code>"#{a} must be equal to #{b}."</code>
</li>
<li>
<strong>less_than</strong>: <code>"#{a} must be less than #{b}."</code>
</li>
<li>
<strong>less_than_or_equal_to</strong>: <code>"#{a} must be less than or equal to #{b}."</code>
</li>
<li>
<strong>odd</strong>: <code>"#{a} must be odd."</code>
</li>
<li>
<strong>even</strong>: <code>"#{a} must be even."</code>
</li>
</ul>

<h3>
<a id="exclusion-and-inclusion-validations" class="anchor" href="#exclusion-and-inclusion-validations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exclusion and Inclusion Validations</h3>

<div class="highlight highlight-coffee"><pre><span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>subdomain<span class="pl-pds">'</span></span>
<span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>size<span class="pl-pds">'</span></span>
<span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>subdomain<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">exclusion:</span></span> [<span class="pl-s"><span class="pl-pds">'</span>www<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>us<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>ca<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>jp<span class="pl-pds">'</span></span>]
<span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>size<span class="pl-pds">'</span></span>,
    <span class="pl-v"><span class="pl-v">inclusion:</span></span> [<span class="pl-s"><span class="pl-pds">'</span>small<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>medium<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>large<span class="pl-pds">'</span></span>]</pre></div>

<h3>
<a id="size" class="anchor" href="#size" aria-hidden="true"><span class="octicon octicon-link"></span></a>Size</h3>

<div class="highlight highlight-coffee"><pre><span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>
<span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>content<span class="pl-pds">'</span></span>
    <span class="pl-v"><span class="pl-v">size:</span></span>
        <span class="pl-en">tokenizer</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">(s)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span> s.match(<span class="pl-sr"><span class="pl-pds">/</span><span class="pl-c1">\w</span><span class="pl-k">+</span><span class="pl-pds">/</span>g</span>).length
        <span class="pl-v"><span class="pl-v">is:</span></span> <span class="pl-c1">5</span>
        <span class="pl-v"><span class="pl-v">minimum:</span></span> <span class="pl-c1">5</span>
        <span class="pl-v"><span class="pl-v">maximum:</span></span> <span class="pl-c1">5</span>
        <span class="pl-v"><span class="pl-v">in:</span></span> [<span class="pl-c1">1</span>,<span class="pl-c1">5</span>]</pre></div>

<p>Options:</p>

<ul>
<li>
<strong>minimum</strong>: <code>"'#{field}' length is #{len}. Must be bigger than #{min}.</code>
</li>
<li>
<strong>maximum</strong>: <code>"'#{field}' length is #{len}. Must be smaller than #{max}."</code>
</li>
<li>
<strong>in</strong>: <code>"'#{field}' length is #{len}. Must be between #{range[0]} and #{range[1]}."</code>
</li>
<li>
<strong>is</strong>: <code>"'#{field}' length is #{len1}. Must be #{len2}."</code>
</li>
<li>
<strong>tokenizer</strong>: useful for splitting the field in different ways. The default is <code>field.length</code>.</li>
</ul>

<h2>
<a id="regex-validations" class="anchor" href="#regex-validations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Regex Validations</h2>

<div class="highlight highlight-coffee"><pre><span class="pl-k">class</span> <span class="pl-en">Player</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
    <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
        <span class="pl-smi">@str</span> <span class="pl-s"><span class="pl-pds">'</span>legacy_code<span class="pl-pds">'</span></span>
        <span class="pl-smi">@validate</span> <span class="pl-s"><span class="pl-pds">'</span>legacy_code<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-v">format:</span></span> <span class="pl-sr"><span class="pl-pds">/</span><span class="pl-k">^</span><span class="pl-c1">[<span class="pl-c1">a-zA-Z</span>]</span><span class="pl-k">+</span><span class="pl-k">$</span><span class="pl-pds">/</span></span></pre></div>

<h2>
<a id="error-handling" class="anchor" href="#error-handling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Error Handling</h2>

<ul>
<li>
<strong>Undefined Attributes</strong>: Using <code>set</code>, <code>add</code> and <code>del</code> on undefined attributes will throw an error <code>"Orpheus :: No Such Model Attribute: #{k}"</code>. Trying to <code>no_such_attribute.incrby(1)</code> will result in <code>TypeError: Object #&lt;Object&gt; has no method 'incrby'</code>. The call stack will directly tell you where the misbehaving attribute sits.</li>
</ul>

<h2>
<a id="remove-a-relationship" class="anchor" href="#remove-a-relationship" aria-hidden="true"><span class="octicon octicon-link"></span></a>Remove a Relationship</h2>

<p>A dynamic function, called <code>"un#{relationship}"()</code>, is available for removing already declared relationships. For example, a user with a books relationship will have an <code>unbook()</code> function available.</p>

<p>This is helpful when trying to abstract away common queries that happen in a lot of requests and denormalize data across relations. Think: points, counters.</p>

<div class="highlight highlight-coffee"><pre><span class="pl-k">class</span> <span class="pl-en">User</span> <span class="pl-k">extends</span> <span class="pl-e">Orpheus</span>
      <span class="pl-en">constructor</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
        <span class="pl-smi">@has</span> <span class="pl-s"><span class="pl-pds">'</span>issue<span class="pl-pds">'</span></span>
        <span class="pl-smi">@num</span> <span class="pl-s"><span class="pl-pds">'</span>comments<span class="pl-pds">'</span></span>
        <span class="pl-smi">@num</span> <span class="pl-s"><span class="pl-pds">'</span>email_replies<span class="pl-pds">'</span></span>

      <span class="pl-en">add_comment</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">(issue_id)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
        <span class="pl-smi">@comments</span>.incrby <span class="pl-c1">1</span>
        <span class="pl-smi">@issue</span>(issue_id)
        <span class="pl-smi">@comments</span>.incrby <span class="pl-c1">1</span>
        <span class="pl-smi">@unissue</span>()


      <span class="pl-en">add_email_reply</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">(issue_id, fn)</span></span> <span class="pl-k"><span class="pl-k">-&gt;</span></span>
        <span class="pl-smi">@add_comment</span> issue_id
        <span class="pl-smi">@email_replies</span>.incrby <span class="pl-c1">1</span>
        <span class="pl-smi">@issue</span>(issue_id)
        <span class="pl-smi">@email_replies</span>.incrby <span class="pl-c1">1</span>
        <span class="pl-smi">@exec</span> fn

    <span class="pl-v"><span class="pl-v">user <span class="pl-k">=</span></span></span> User.create()
    user(<span class="pl-s"><span class="pl-pds">'</span>rada<span class="pl-pds">'</span></span>).add_email_reply <span class="pl-s"><span class="pl-pds">'</span>#142<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
      <span class="pl-c"># everything went better than expected...</span></pre></div>

<h2>
<a id="development" class="anchor" href="#development" aria-hidden="true"><span class="octicon octicon-link"></span></a>Development</h2>

<h3>
<a id="test" class="anchor" href="#test" aria-hidden="true"><span class="octicon octicon-link"></span></a>Test</h3>

<p><code>cake test</code></p>

<h3>
<a id="contribute" class="anchor" href="#contribute" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contribute</h3>

<ul>
<li><code>cake dev</code></li>
<li>Add your tests.</li>
<li>Do your thing.</li>
<li><code>cake dev</code></li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Radagaisus/Orpheus">Orpheus</a> is maintained by <a href="https://github.com/Radagaisus">Radagaisus</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-34452869-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

